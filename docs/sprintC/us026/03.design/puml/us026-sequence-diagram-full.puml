@startuml
skinparam monochrome true
skinparam packageStyle rectangle
skinparam shadowing false

autonumber

'hide footbox
actor "HRM" as ADM
participant ":AddVehiclesToTaskUI" as UI
participant ":AddVehiclesToTaskController" as CTRL
participant ":Repositories" as RepositorySingleton
participant "repositories\n:Repositories" as PLAT
participant "AuthFacade\n:AuthenticationRepository" as AUTHREP
participant "userSession\n:UserSession" as USER
participant "organizationRepository:\nOrganizationRepository" as OrganizationRepository
participant "organization\n:Organization" as ORG
participant "employee\n:Employee" as EMP
participant "taskRepository:\nTaskRepository" as TASKREP
participant "vehicleRepository:\nVehicleRepository" as VEHREP
participant "task:\nTask" as TASK


activate ADM

    ADM -> UI : asks to assign vehicles to an entry in the Agenda.
    activate UI

        UI -> CTRL : getThisGsmTasksInAgenda()
                activate CTRL


        CTRL -> CTRL : getUserFromSession()

        CTRL -> RepositorySingleton : getInstance()
        activate RepositorySingleton
        CTRL <-- RepositorySingleton : Repositories
        deactivate RepositorySingleton

        CTRL -> PLAT : getAuthenticationRepository()

        activate PLAT
        CTRL <-- PLAT : AuthenticationRepository()
        deactivate PLAT

        CTRL -> AUTHREP : getCurrentUserSession()

        activate AUTHREP

        AUTHREP -> USER : isLoggedWithRule(GSM)

        activate USER

        AUTHREP <-- USER : "True/False"
        AUTHREP --> USER : getUserId(email)
        AUTHREP <-- USER : userId(email)
        deactivate USER

        CTRL <-- AUTHREP : userId(email)
        deactivate AUTHREP
        CTRL -> CTRL : getOrganizationByEmployeeEmail(email)
        CTRL -> RepositorySingleton : getInstance()
        activate RepositorySingleton
        CTRL <-- RepositorySingleton : Repositories
        deactivate RepositorySingleton
        CTRL -> PLAT : getOrganizationRepository()
        activate PLAT
        CTRL <-- PLAT : OrganizationRepository()
        deactivate PLAT
        CTRL -> OrganizationRepository :getOrganizationByUserId(email)
        activate OrganizationRepository
            loop for each organization
            OrganizationRepository -> ORG : anyUserHasId(email)
            activate ORG
            OrganizationRepository <-- ORG : True/False
            deactivate ORG
            end loop
        CTRL <-- OrganizationRepository : organitazion
        deactivate OrganizationRepository



            CTRL -> RepositorySingleton : getInstance()
            activate RepositorySingleton
            CTRL <-- RepositorySingleton : repositories
            deactivate RepositorySingleton
            CTRL -> PLAT : getTaskRepository()
            activate PLAT
            CTRL <-- PLAT : taskRepository
            deactivate PLAT
            CTRL->TASKREP : getThisGsmTasksInAgenda()
            activate TASKREP
            CTRL<-- TASKREP : listThisGsmTasksInAgenda
            deactivate TASKREP
            UI <-- CTRL : listThisGsmTasksInAgenda
            deactivate CTRL
            ADM <-- UI : List tasks in the Agenda and ask to select one
            deactivate UI
            ADM -> UI : Selects task
            activate UI

            UI-> CTRL : listVehiclesNotAssignedByDateOfTasks()

            activate CTRL

                        CTRL -> RepositorySingleton : getInstance()
                        activate RepositorySingleton
                        CTRL <-- RepositorySingleton : repositories
                        deactivate RepositorySingleton
                        CTRL -> PLAT : getVehiclesRepository()
                        activate PLAT
                        CTRL <-- PLAT : vehiclesRepository
                        deactivate PLAT
                        CTRL->VEHREP : filterVehiclesNotAssignedByDateOfTasks()
                        activate VEHREP
                        CTRL<-- VEHREP : listVehiclesNotAssignedByDateOfTasks()
                        deactivate VEHREP
                        UI <-- CTRL : VehiclesNotAssignedByDateOfTasks
                        deactivate CTRL
                        ADM <-- UI : List all available vehicles that can be selected
                        deactivate UI
                        ADM -> UI : Selects one or more vehicles
                        activate UI

            UI --> ADM : Show data and request confirmation
            deactivate UI

            ADM -> UI : submits data
            activate UI

            UI -> CTRL : updateTaskVehicles(task, vehicles)
            activate CTRL

            CTRL -> EMP: updateTaskVehicles(task, vehicles)
            activate EMP

                EMP -> TASK**: updateTaskVehicles(task, vehicles)

                activate EMP
                    EMP -> EMP: addUpdatedTaskVehicles(task, vehicles)
                    EMP -> EMP: validateTask(task, vehicles)
                    EMP --> EMP
                    EMP --> EMP

                EMP --> CTRL : UpdatedTask

            deactivate ORG

            CTRL --> UI: UpdatedTask
            deactivate CTRL
            UI --> ADM: displays operation success
    deactivate UI

deactivate ADM


@enduml